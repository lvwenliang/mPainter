/*!
mPainter v0.5.2 
Author: Mark Zhou 
Date: 2013-10-30 
License: MIT 
*/
!function(a,b){"use strict";function c(a){d(),a.widget.enable===!0&&e(a.widget)}function d(){var a=U(V.options.hook_id);if(!a)throw"Hook #: "+V.options.hook_id+" is not found on the page. mPainter initilization failure.";var b=J("svg",{id:V.options.id,width:V.options.width,height:V.options.height});a.appendChild(b)}function e(){var a=U(V.options.hook_id),b=document.createElement("div");b.setAttribute("class",V.options.UI.widget_group_classname);var c=g();b.appendChild(c[0]),b.appendChild(c[1]);var d=h();b.appendChild(d[0]),b.appendChild(d[1]);var e=i();b.appendChild(e[0]),b.appendChild(e[1]);var f=j();f.forEach(function(a){b.appendChild(a)});var k=document.createElement("div");k.style.clear="both",b.appendChild(k),a.insertBefore(b,a.childNodes[0])}function f(a,b,c){var d=document.createElement("div");d.setAttribute("class","m-"+a+"-selector");var e=document.createElement("ul");e.setAttribute("class","m-"+a+"-list");var f=document.createElement("div");d.appendChild(f);for(var g=[],h=0,i=b;i>h;h++){var j=document.createElement("li"),k=document.createElement("div");k.setAttribute("class","m-"+a),j.appendChild(k),e.appendChild(j),g.push(k)}return d.addEventListener("mouseover",function(){e.setAttribute("style","display:block;")},!1),d.addEventListener("mouseout",function(a){var b=a.toElement||a.relatedTarget;R(e,b)||b===e||e.setAttribute("style","display:none;")},!1),e.addEventListener("mouseout",function(a){var b=a.toElement||a.relatedTarget,c=a.fromElement||a.relatedTarget;(c!==e&&!R(e,c)||b!==e&&!R(e,b))&&e.setAttribute("style","display:none;")}),e.addEventListener("click",function(b){var d;"LI"===b.target.tagName?d=b.target.getElementsByTagName("div")[0]:-1!==b.target.className.indexOf("m-"+a)&&(d=b.target),d&&c(d,f)},!1),[d,e,f,g]}function g(){var a=V.options.WIDGETS.COLOR.HEX.length,b=function(a){var b=a.style["background-color"];V.setColor(b),V.options.WIDGETS.COLOR.ELEMENTS.forEach(function(a){a.style["background-color"]=b})},c=f("color",a,b),d=c[0],e=c[1],g=c[2],h=c[3];return g.style["background-color"]=V.options.WIDGETS.COLOR.HEX[0],V.options.WIDGETS.COLOR.ELEMENTS.push(g),h.forEach(function(a,b){a.style["background-color"]=V.options.WIDGETS.COLOR.HEX[b]}),[d,e]}function h(){var a=V.options.WIDGETS.TOOL.TYPE.length,b=function(a,b){var c=a.getAttribute("data-tool"),d=a.innerText;V.setTool(c),b.innerText=d},c=f("tool",a,b),d=c[0],e=c[1],g=c[2],h=c[3],i=V.options.WIDGETS.TOOL.TYPE[0];return g.innerText=V.options.WIDGETS.TOOL[i].ICON,h.forEach(function(a,b){var c=V.options.WIDGETS.TOOL.TYPE[b],d=V.options.WIDGETS.TOOL[c].ICON;a.setAttribute("data-tool",c),a.innerText=d}),[d,e]}function i(){var a=V.options.WIDGETS.SIZE.length,b=function(a,b){var c=a.style.width,d=c.substring(0,c.length-2)/2;V.setSize(d),b.getElementsByTagName("div")[0].style.width=c,b.getElementsByTagName("div")[0].style.height=c},c=f("size",a,b),d=c[0],e=c[1],g=c[2],h=c[3],i=document.createElement("div");return i.setAttribute("class","m-size"),i.style.width=V.options.WIDGETS.SIZE[0]+"px",i.style.height=V.options.WIDGETS.SIZE[0]+"px",i.style["background-color"]=V.options.WIDGETS.COLOR.HEX[0],g.appendChild(i),V.options.WIDGETS.COLOR.ELEMENTS.push(i),h.forEach(function(a,b){var c=V.options.WIDGETS.SIZE[b];a.style.width=c+"px",a.style.height=c+"px",a.style["background-color"]=V.options.WIDGETS.COLOR.HEX[0],V.options.WIDGETS.COLOR.ELEMENTS.push(a)}),[d,e]}function j(){var a=[],b=function(a){return function(){Q(V[a.METHOD])&&V[a.METHOD].call(V)}};for(var c in V.options.WIDGETS.GENERAL)if(V.options.WIDGETS.GENERAL.hasOwnProperty(c)){var d=V.options.WIDGETS.GENERAL[c],e=document.createElement("div"),f=document.createElement("span");f.innerText=d.ICON,f.setAttribute("class","m-"+d.METHOD),e.appendChild(f),e.setAttribute("class","m-button"),e.setAttribute("title",d.METHOD),e.addEventListener("click",b(d),!1),a.push(e)}return a}function k(){V.options.start_trigger.forEach(function(a){X.el.addEventListener(a,l,!1)}),V.options.move_trigger.forEach(function(a){X.el.addEventListener(a,m,!1)}),V.options.stop_trigger.forEach(function(a){X.el.addEventListener(a,n,!1)}),X.el.addEventListener("mouseover",o,!1),X.el.addEventListener("mouseout",p,!1)}function l(a){if(a.preventDefault(),a.stopPropagation(),I()){X.paint_start===b&&(X.paint_start=N());var c=K(a);O("Start: "+c.x+","+c.y),q(c,X.config),X.is_mousedown=!0}}function m(a){if(X.is_mousedown===!0){a.preventDefault(),a.stopPropagation();var b=K(a);O("Move: "+b.x+","+b.y),q(b,X.config)}F(a)}function n(a){if(a.preventDefault(),a.stopPropagation(),X.is_mousedown===!0){var b=K(a);O("Stop: "+b.x+","+b.y),q(b,X.config),s()}}function o(a){L(a,X.el)&&(O("Enter",a),C(a))}function p(a){var b=a.toElement?a.toElement:a.relatedTarget;(null===b||"svg"!==b.nodeName&&"svg"!==b.parentNode.nodeName&&b.id!==V.options.cursor_id)&&(X.is_mousedown===!0&&(O("Out",a),s()),G())}function q(a,b){A(b.element_index).push(a),w(b)}function r(a){return X.paint_stack.elements[a]={config:{element_index:a,tool:X.config.tool,painter_radius:X.config.painter_radius,opacity:X.config.opacity,color:X.config.color},points:[],is_deleted:!1},X.paint_stack.elements[a]}function s(){X.is_mousedown=!1,u(X.config);for(var a=X.redo.length-1;a>=0;a--)X.undo.push({id:X.redo[a].id,value:M(X.redo[a].value)});for(var b=0,c=X.redo.length;c>b;b++)X.undo.push({id:X.redo[b].id,value:X.redo[b].value});X.undo.push({id:X.config.element_index,value:"d"}),X.redo=[],X.config.element_index++}function t(a){var b=U(V.options.element_prefix+a);b&&b.parentNode.removeChild(b)}function u(a){var b=U(V.options.element_prefix+a.element_index);b&&b.setAttribute("opacity",a.opacity)}function v(){for(;X.el.lastChild;)X.el.removeChild(X.el.lastChild)}function w(a,b){switch(a.tool){case V.options.WIDGETS.TOOL.PAINT.NAME:x(a,b);break;case V.options.WIDGETS.TOOL.LINE.NAME:z(a,b)}}function x(a,b){var c=V.options.element_prefix+a.element_index,d=U(c);d?d.setAttribute("d",y(a.element_index,b)):(d=J("path",{id:c,d:y(a.element_index,b),fill:"none",stroke:a.color,"stroke-linecap":"round","stroke-width":2*a.painter_radius,opacity:a.opacity/2}),X.el.appendChild(d))}function y(a,b){var c=b||A(a),d=c.length,e=0===d%2?d-1:d-2,f="M"+c[0].x+","+c[0].y;if(1===d)return f;if(2===d||3===d)return f+"T"+c[d-1].x+","+c[d-1].y;f+="Q";for(var g=1;e>g;g++)f+=c[g].x+","+c[g].y+" ";return f+="T"+c[e].x+","+c[e].y}function z(a,b){var c=V.options.element_prefix+a.element_index,d=U(c);if(d){var e=B(b,a.element_index);d.setAttribute("x2",e.x),d.setAttribute("y2",e.y)}else{var f=B(b,a.element_index,0),g=B(b,a.element_index);d=J("line",{id:c,x1:f.x,y1:f.y,x2:g.x,y2:g.y,"stroke-linecap":"round","stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2}),X.el.appendChild(d)}}function A(a){return X.paint_stack.elements[a]===b?r(a).points:X.paint_stack.elements[a].points}function B(a,c,d){var e=a||A(c);return d===b?e[e.length-1]:e[d]}function C(a){switch(X.config.tool){case V.options.WIDGETS.TOOL.PAINT.NAME:D(a);break;case V.options.WIDGETS.TOOL.LINE.NAME:E(a)}}function D(a){var b=J("circle",{id:V.options.cursor_id,cx:a.offsetX,cy:a.offsetY,r:X.config.painter_radius,stroke:X.config.color,fill:X.config.color});X.el.appendChild(b)}function E(){var a="";X.el.getAttribute("style")&&(a=X.el.getAttribute("style")),X.el.setAttribute("style",a+"cursor:crosshair;")}function F(a){var b=U(V.options.cursor_id);b&&(b.setAttribute("cx",a.offsetX),b.setAttribute("cy",a.offsetY))}function G(){var a=U(V.options.cursor_id),b=X.el.getAttribute("style");a&&a.parentNode.removeChild(a),b&&X.el.setAttribute("style",b.replace(/cursor:crosshair;/,""))}function H(a){if(X[a].length){var b=X[a].pop(),c=b.id,d=b.value;switch(X[M(a)].push({id:c,value:M(d)}),d){case"a":X.paint_stack.elements[c].is_deleted=!1;var e=X.paint_stack.elements[c].config;e.opacity*=2,w(e);break;case"d":X.paint_stack.elements[c].is_deleted=!0,t(c)}}}function I(){return X.replay_in_progress===!0?!1:!0}function J(a,b){var c=document.createElementNS(Y,a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}function K(b){var c,d,e=b||a.event;return P(e)?e.targetTouches.length?(c=e.targetTouches[0].clientX,d=e.targetTouches[0].clientY-X.el.offsetTop+a.scrollY):(c=e.changedTouches[0].clientX,d=e.changedTouches[0].clientY-X.el.offsetTop+a.scrollY):(c=e.offsetX,d=e.offsetY),{x:c,y:d,timestamp:N()}}function L(a,b){for(var c=a.relatedTarget||a.toElement||a.fromElement;c&&c!==b;)c=c.parentNode;return c!==b?!0:!1}function M(a){return"d"===a?"a":"a"===a?"d":"redo"===a?"undo":"undo"===a?"redo":a}function N(){return+new Date}function O(a){V.options.debug===!0&&console.log(a)}function P(){return event.type.search("touch")>-1}function Q(a){return"function"==typeof a}function R(a,b){for(var c=b.parentNode;null!==c;){if(c===a)return!0;c=c.parentNode}return!1}function S(){for(var a={},b=0,c=arguments.length;c>b;b++)for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}function T(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||function(b){a.setTimeout(b,1e3/60)}}function U(a){return document.getElementById(a)}var V,W=a.mPainter||{},X={},Y="http://www.w3.org/2000/svg";W=function(a,d){var e={id:"m-board",cursor_id:"m-cursor",element_prefix:"element_",ui:{widget:{enable:!0}},width:600,height:400,hook_id:a,start_trigger:["mousedown","touchstart","MSPointerDown"],move_trigger:["mousemove","touchmove","MSPointerMove"],stop_trigger:["mouseup","touchend","touchcancel","MSPointerUp"],debug:!1},f={UI:{widget_group_classname:"m-button-groups"},WIDGETS:{COLOR:{HEX:["#FF0000","#0063DC","#66CEFF","#73BA37","#FFCC33","#E47911","#FF0084","#6441A5","#C7C5E6","#171515"],ELEMENTS:[]},TOOL:{TYPE:["PAINT","LINE"],PAINT:{NAME:"PAINT",ICON:"✐"},LINE:{NAME:"LINE",ICON:"✑"}},SIZE:[4,8,12],GENERAL:{UNDO:{METHOD:"undo",ICON:"↶"},REDO:{METHOD:"redo",ICON:"↷"},REPLAY:{METHOD:"replay",ICON:"⟳"},RESET:{METHOD:"reset",ICON:"♲"}}}};this.options=S(e,d,f),V=this,c(this.options.ui),X={el:U(this.options.id),undo:[],redo:[],is_mousedown:!1,replay_in_progress:!1,paint_start:b,paint_stack:{elements:[]},config:{element_index:0,tool:"PAINT",painter_radius:2,opacity:1,color:"#FF0000"}},k()},W.prototype={setColor:function(a){X.config.color=a},setSize:function(a){X.config.painter_radius=a},setOpacity:function(a){X.config.opacity=a},setTool:function(a){if(!this.options.WIDGETS.TOOL[a])throw"TOOL: "+a+" is not available.";X.config.tool=a},undo:function(){H("undo")},redo:function(){H("redo")},saveImage:function(){var b=U("mycanvas"),c=b.getContext("2d"),d=(new XMLSerializer).serializeToString(X.el),e=a.URL||a.webkitURL||a,f=document.createElement("img"),g=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),h=e.createObjectURL(g);f.onload=function(){c.drawImage(f,0,0,b.width,b.height),b.toDataURL("image/png")},f.src=h},replay:function(a){var c=X.paint_stack.elements,d=c.length,e=T(),f=N(),g=0,h=0,i=0,j=0,k=[];X.replay_in_progress=!0,v();var l=function(){var m,n,o,p=X.paint_start+g+(N()-f);for(o=h;d-1>=o;o++){var q=c[o].points,r=q[0].timestamp,s=q[q.length-1].timestamp;if(c[o].is_deleted!==!0){if(s>p)break}else g+=s-r}for(o>d-1&&(o=d-1),m=h;o>=m;m++){var t=c[m],v=t.points.length;if(t.is_deleted!==!0)for(n=i;v>n;n++){var x=t.points[n];if(x.timestamp>p){i=n;break}k.push(x),w(t.config,k),k.length===v&&(i=0,k=[],j++,u(t.config))}}j===d?(X.replay_in_progress=!1,a!==b&&Q(a)&&a()):(h=o,e(l))};e(l)},getJSON:function(){return X.paint_stack},renderJSON:function(a){if(a.elements!==b)for(var c=0,d=a.elements.length;d>c;c++){var e=a.elements[c];e.is_deleted===!1&&(e.config.opacity*=2,w(e.config,e.points))}},reset:function(){X.undo=[],X.redo=[],X.config.element_index=0,X.is_mousedown=!1,X.paint_start=b,X.paint_stack={elements:[]},v()}},a.mPainter=W}(window);