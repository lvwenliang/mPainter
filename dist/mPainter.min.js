/*!
mPainter v0.6.0 
Author: Mark Zhou 
Date: 2013-11-01 
License: MIT 
*/
!function(a,b){"use strict";function c(a){d(),a.widget.enable===!0&&e(a.widget)}function d(){var a=X(Y.options.hook_id);if(!a)throw"Hook #: "+Y.options.hook_id+" is not found on the page. mPainter initilization failure.";var b=L("svg",{id:Y.options.id,width:Y.options.width,height:Y.options.height});a.appendChild(b)}function e(){var a=X(Y.options.hook_id),b=document.createElement("div");b.setAttribute("class",Y.options.UI.widget_group_classname);var c=g();b.appendChild(c[0]),b.appendChild(c[1]);var d=h();b.appendChild(d[0]),b.appendChild(d[1]);var e=i();b.appendChild(e[0]),b.appendChild(e[1]);var f=j();f.forEach(function(a){b.appendChild(a)});var k=document.createElement("div");k.style.clear="both",b.appendChild(k),a.insertBefore(b,a.childNodes[0])}function f(a,b,c){var d=document.createElement("div");d.setAttribute("class","m-"+a+"-selector");var e=document.createElement("ul");e.setAttribute("class","m-"+a+"-list");var f=document.createElement("div");d.appendChild(f);for(var g=[],h=0,i=b;i>h;h++){var j=document.createElement("li"),k=document.createElement("div");k.setAttribute("class","m-"+a),j.appendChild(k),e.appendChild(j),g.push(k)}return d.addEventListener("mouseover",function(){e.style.display="block"},!1),d.addEventListener("mouseout",function(a){var b=a.toElement||a.relatedTarget;U(e,b)||b===e||(e.style.display="none")},!1),e.addEventListener("mouseout",function(a){var b=a.toElement||a.relatedTarget,c=a.fromElement||a.relatedTarget;(c!==e&&!U(e,c)||b!==e&&!U(e,b))&&(e.style.display="none")}),e.addEventListener("click",function(b){var d;"LI"===b.target.tagName?d=b.target.getElementsByTagName("div")[0]:-1!==b.target.className.indexOf("m-"+a)&&(d=b.target),d&&c(d,f)},!1),[d,e,f,g]}function g(){var a=Y.options.WIDGETS.COLOR.HEX.length,b=function(a){var b=a.style["background-color"];Y.setColor(b),Y.options.WIDGETS.COLOR.ELEMENTS.forEach(function(a){a.style["background-color"]=b})},c=f("color",a,b),d=c[0],e=c[1],g=c[2],h=c[3];return g.style["background-color"]=Y.options.WIDGETS.COLOR.HEX[0],Y.options.WIDGETS.COLOR.ELEMENTS.push(g),h.forEach(function(a,b){a.style["background-color"]=Y.options.WIDGETS.COLOR.HEX[b]}),[d,e]}function h(){var a=Y.options.WIDGETS.TOOL.TYPE.length,b=function(a,b){var c=a.getAttribute("data-tool"),d=a.innerText;Y.setTool(c),b.innerText=d},c=f("tool",a,b),d=c[0],e=c[1],g=c[2],h=c[3],i=Y.options.WIDGETS.TOOL.TYPE[0];return g.innerText=Y.options.WIDGETS.TOOL[i].ICON,h.forEach(function(a,b){var c=Y.options.WIDGETS.TOOL.TYPE[b],d=Y.options.WIDGETS.TOOL[c].ICON;a.setAttribute("data-tool",c),a.innerText=d}),[d,e]}function i(){var a=Y.options.WIDGETS.SIZE.length,b=function(a,b){var c=a.style.width,d=c.substring(0,c.length-2)/2;Y.setSize(d),b.getElementsByTagName("div")[0].style.width=c,b.getElementsByTagName("div")[0].style.height=c},c=f("size",a,b),d=c[0],e=c[1],g=c[2],h=c[3],i=document.createElement("div");return i.setAttribute("class","m-size"),i.style.width=Y.options.WIDGETS.SIZE[0]+"px",i.style.height=Y.options.WIDGETS.SIZE[0]+"px",i.style["background-color"]=Y.options.WIDGETS.COLOR.HEX[0],g.appendChild(i),Y.options.WIDGETS.COLOR.ELEMENTS.push(i),h.forEach(function(a,b){var c=Y.options.WIDGETS.SIZE[b];a.style.width=c+"px",a.style.height=c+"px",a.style["background-color"]=Y.options.WIDGETS.COLOR.HEX[0],Y.options.WIDGETS.COLOR.ELEMENTS.push(a)}),[d,e]}function j(){var a=[],b=function(a){return function(){T(Y[a.METHOD])&&Y[a.METHOD].call(Y)}};for(var c in Y.options.WIDGETS.GENERAL)if(Y.options.WIDGETS.GENERAL.hasOwnProperty(c)){var d=Y.options.WIDGETS.GENERAL[c],e=document.createElement("div"),f=document.createElement("span");f.innerText=d.ICON,f.setAttribute("class","m-"+d.METHOD),e.appendChild(f),e.setAttribute("class","m-button"),e.setAttribute("title",d.METHOD),e.addEventListener("click",b(d),!1),a.push(e)}return a}function k(){Y.options.start_trigger.forEach(function(a){$.el.addEventListener(a,l,!1)}),Y.options.move_trigger.forEach(function(a){$.el.addEventListener(a,m,!1)}),Y.options.stop_trigger.forEach(function(a){$.el.addEventListener(a,n,!1)}),$.el.addEventListener("mouseover",o,!1),$.el.addEventListener("mouseout",p,!1)}function l(a){if(a.preventDefault(),a.stopPropagation(),K()){$.paint_start===b&&($.paint_start=Q());var c=N(a),d=C($.config.element_index);R("Start: "+c.x+","+c.y),q(c,d),$.is_mousedown=!0}}function m(a){if($.is_mousedown===!0){a.preventDefault(),a.stopPropagation();var b=N(a),c=C($.config.element_index);R("Move: "+b.x+","+b.y),q(b,c),w($.config,c)}H(a)}function n(a){if(a.preventDefault(),a.stopPropagation(),$.is_mousedown===!0){var b=N(a),c=C($.config.element_index);R("Stop: "+b.x+","+b.y),q(b,c),w($.config,c),s()}}function o(a){O(a,$.el)&&(R("Enter",a),E(a))}function p(a){var b=a.toElement?a.toElement:a.relatedTarget;(null===b||"svg"!==b.nodeName&&"svg"!==b.parentNode.nodeName&&b.id!==Y.options.cursor_id)&&($.is_mousedown===!0&&(R("Out",a),s()),I())}function q(a,b){b.push(a)}function r(a){return $.paint_stack.elements[a]={config:{element_index:a,tool:$.config.tool,painter_radius:$.config.painter_radius,opacity:$.config.opacity,color:$.config.color},points:[],is_deleted:!1},$.paint_stack.elements[a]}function s(){$.is_mousedown=!1,u($.config);for(var a=$.redo.length-1;a>=0;a--)$.undo.push({id:$.redo[a].id,value:P($.redo[a].value)});for(var b=0,c=$.redo.length;c>b;b++)$.undo.push({id:$.redo[b].id,value:$.redo[b].value});$.undo.push({id:$.config.element_index,value:"d"}),$.redo=[],$.config.element_index++}function t(a){var b=X(Y.options.element_prefix+a);b&&b.parentNode.removeChild(b)}function u(a){var b=X(Y.options.element_prefix+a.element_index);b&&b.setAttribute("opacity",a.opacity)}function v(){for(;$.el.lastChild;)$.el.removeChild($.el.lastChild)}function w(a,b){switch(a.tool){case Y.options.WIDGETS.TOOL.FREE.NAME:x(a,b);break;case Y.options.WIDGETS.TOOL.LINE.NAME:z(a,b);break;case Y.options.WIDGETS.TOOL.RECT.NAME:A(a,b);break;case Y.options.WIDGETS.TOOL.ELLIPSE.NAME:B(a,b)}}function x(a,b){var c=Y.options.element_prefix+a.element_index,d=X(c);d?M(d,{d:y(a.element_index,b)}):(d=L("path",{id:c,d:y(a.element_index,b),stroke:a.color,"stroke-width":2*a.painter_radius,opacity:a.opacity/2,fill:"none","stroke-linecap":"round"}),$.el.appendChild(d))}function y(a,b){var c=b||C(a),d=c.length,e=0===d%2?d-1:d-2,f="M"+c[0].x+","+c[0].y;if(2===d||3===d)return f+"T"+c[d-1].x+","+c[d-1].y;f+="Q";for(var g=1;e>g;g++)f+=c[g].x+","+c[g].y+" ";return f+="T"+c[e].x+","+c[e].y}function z(a,b){var c=Y.options.element_prefix+a.element_index,d=X(c);if(d){var e=D(b,a.element_index);M(d,{x2:e.x,y2:e.y})}else{var f=D(b,a.element_index,0),g=D(b,a.element_index);d=L("line",{id:c,x1:f.x,y1:f.y,x2:g.x,y2:g.y,"stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2,"stroke-linecap":"round"}),$.el.appendChild(d)}}function A(a,b){var c=Y.options.element_prefix+a.element_index,d=X(c),e=D(b,a.element_index,0),f=D(b,a.element_index),g=Math.min(e.x,f.x),h=Math.min(e.y,f.y),i=Math.abs(e.x-f.x),j=Math.abs(e.y-f.y);d?M(d,{x:g,y:h,width:i,height:j}):(d=L("rect",{id:c,x:g,y:h,width:i,height:j,"stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2,fill:"none"}),$.el.appendChild(d))}function B(a,b){var c=Y.options.element_prefix+a.element_index,d=X(c),e=D(b,a.element_index,0),f=D(b,a.element_index),g=Math.abs(e.x-f.x),h=Math.abs(e.y-f.y);console.log(e,f,g,h),d?M(d,{rx:g,ry:h}):(d=L("ellipse",{id:c,cx:e.x,cy:e.y,rx:g,ry:h,"stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2,fill:"none"}),$.el.appendChild(d))}function C(a){return $.paint_stack.elements[a]===b?r(a).points:$.paint_stack.elements[a].points}function D(a,c,d){var e=a||C(c);return d===b?e[e.length-1]:e[d]}function E(a){switch($.config.tool){case Y.options.WIDGETS.TOOL.FREE.NAME:F(a);break;case Y.options.WIDGETS.TOOL.LINE.NAME:case Y.options.WIDGETS.TOOL.RECT.NAME:case Y.options.WIDGETS.TOOL.ELLIPSE.NAME:G(a)}}function F(a){var b=L("circle",{id:Y.options.cursor_id,cx:a.offsetX,cy:a.offsetY,r:$.config.painter_radius,stroke:$.config.color,fill:$.config.color});$.el.appendChild(b)}function G(){var a="";$.el.getAttribute("style")&&(a=$.el.getAttribute("style")),$.el.setAttribute("style",a+"cursor:crosshair;")}function H(a){var b=X(Y.options.cursor_id);b&&M(b,{cx:a.offsetX,cy:a.offsetY})}function I(){var a=X(Y.options.cursor_id),b=$.el.getAttribute("style");a&&a.parentNode.removeChild(a),b&&$.el.setAttribute("style",b.replace(/cursor:crosshair;/,""))}function J(a){if($[a].length){var b=$[a].pop(),c=b.id,d=b.value;switch($[P(a)].push({id:c,value:P(d)}),d){case"a":$.paint_stack.elements[c].is_deleted=!1;var e=$.paint_stack.elements[c].config;e.opacity*=2,w(e,$.paint_stack.elements[c].points);break;case"d":$.paint_stack.elements[c].is_deleted=!0,t(c)}}}function K(){return $.replay_in_progress===!0?!1:!0}function L(a,b){var c=document.createElementNS(_,a);return b&&(c=M(c,b)),c}function M(a,b){for(var c in b)b.hasOwnProperty(c)&&a.setAttribute(c,b[c]);return a}function N(b){var c,d,e=b||a.event;return S(e)?e.targetTouches.length?(c=e.targetTouches[0].clientX,d=e.targetTouches[0].clientY-$.el.offsetTop+a.scrollY):(c=e.changedTouches[0].clientX,d=e.changedTouches[0].clientY-$.el.offsetTop+a.scrollY):(c=e.offsetX,d=e.offsetY),{x:c,y:d,timestamp:Q()}}function O(a,b){for(var c=a.relatedTarget||a.toElement||a.fromElement;c&&c!==b;)c=c.parentNode;return c!==b}function P(a){return"d"===a?"a":"a"===a?"d":"redo"===a?"undo":"undo"===a?"redo":a}function Q(){return+new Date}function R(a){Y.options.debug===!0&&console.log(a)}function S(){return event.type.search("touch")>-1}function T(a){return"function"==typeof a}function U(a,b){for(var c=b.parentNode;null!==c;){if(c===a)return!0;c=c.parentNode}return!1}function V(){for(var a={},b=0,c=arguments.length;c>b;b++)for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}function W(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||function(b){a.setTimeout(b,1e3/60)}}function X(a){return document.getElementById(a)}var Y,Z=a.mPainter||{},$={},_="http://www.w3.org/2000/svg";Z=function(a,d){var e={id:"m-board",cursor_id:"m-cursor",element_prefix:"element_",ui:{widget:{enable:!0}},width:600,height:400,hook_id:a,start_trigger:["mousedown","touchstart","MSPointerDown"],move_trigger:["mousemove","touchmove","MSPointerMove"],stop_trigger:["mouseup","touchend","touchcancel","MSPointerUp"],debug:!1},f={UI:{widget_group_classname:"m-button-groups"},WIDGETS:{COLOR:{HEX:["#FF0000","#0063DC","#66CEFF","#73BA37","#FFCC33","#E47911","#FF0084","#6441A5","#C7C5E6","#171515"],ELEMENTS:[]},TOOL:{TYPE:["FREE","LINE","RECT","ELLIPSE"],FREE:{NAME:"FREE",ICON:"✐"},LINE:{NAME:"LINE",ICON:"✑"},RECT:{NAME:"RECT",ICON:"▭"},ELLIPSE:{NAME:"ELLIPSE",ICON:"◯"}},SIZE:[4,8,12],GENERAL:{UNDO:{METHOD:"undo",ICON:"↶"},REDO:{METHOD:"redo",ICON:"↷"},REPLAY:{METHOD:"replay",ICON:"⟳"},RESET:{METHOD:"reset",ICON:"♲"}}}};this.options=V(e,d,f),Y=this,c(this.options.ui),$={el:X(this.options.id),undo:[],redo:[],is_mousedown:!1,replay_in_progress:!1,paint_start:b,paint_stack:{elements:[]},config:{element_index:0,tool:this.options.WIDGETS.TOOL.TYPE[0],painter_radius:2,opacity:1,color:this.options.WIDGETS.COLOR.HEX[0]}},k()},Z.prototype={setColor:function(a){$.config.color=a},setSize:function(a){$.config.painter_radius=a},setOpacity:function(a){$.config.opacity=a},setTool:function(a){if(!this.options.WIDGETS.TOOL[a])throw"TOOL: "+a+" is not available.";$.config.tool=a},undo:function(){J("undo")},redo:function(){J("redo")},saveImage:function(){var b=X("mycanvas"),c=b.getContext("2d"),d=(new XMLSerializer).serializeToString($.el),e=a.URL||a.webkitURL||a,f=document.createElement("img"),g=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),h=e.createObjectURL(g);f.onload=function(){c.drawImage(f,0,0,b.width,b.height),b.toDataURL("image/png")},f.src=h},replay:function(a){var c=$.paint_stack.elements,d=c.length,e=W(),f=Q(),g=0,h=0,i=0,j=0,k=[];$.replay_in_progress=!0,v();var l=function(){var m,n,o,p=$.paint_start+g+(Q()-f);for(o=h;d-1>=o;o++){var q=c[o].points,r=q[0].timestamp,s=q[q.length-1].timestamp;if(c[o].is_deleted!==!0){if(s>p)break}else g+=s-r}for(o>d-1&&(o=d-1),m=h;o>=m;m++){var t=c[m],v=t.points.length;if(t.is_deleted!==!0)for(n=i;v>n;n++){var x=t.points[n];if(x.timestamp>p){i=n;break}k.push(x),w(t.config,k),k.length===v&&(i=0,k=[],j++,u(t.config))}}j===d?($.replay_in_progress=!1,a!==b&&T(a)&&a()):(h=o,e(l))};e(l)},getJSON:function(){return $.paint_stack},setJSON:function(a){if(a.elements!==b)for(var c=0,d=a.elements.length;d>c;c++){var e=a.elements[c];e.is_deleted===!1&&(e.config.opacity*=2,w(e.config,e.points))}},reset:function(){$.undo=[],$.redo=[],$.config.element_index=0,$.is_mousedown=!1,$.replay_in_progress=!1,$.paint_start=b,$.paint_stack={elements:[]},v()}},a.mPainter=Z}(window);