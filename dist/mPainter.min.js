/*!
mPainter v0.5.1 
Author: Mark Zhou 
Date: 2013-10-30 
License: MIT 
*/
!function(a,b){"use strict";function c(a){d(),a.widget.enable===!0&&e(a.widget)}function d(){var a=S(T.options.hook_id);if(!a)throw"Hook #: "+T.options.hook_id+" is not found on the page. mPainter initilization failure.";var b=H("svg",{id:T.options.id,width:T.options.width,height:T.options.height});a.appendChild(b)}function e(){var a=S(T.options.hook_id),b=document.createElement("div");b.setAttribute("class",T.options.UI.widget_group_classname);var c=g();b.appendChild(c[0]),b.appendChild(c[1]);var d=h();b.appendChild(d[0]),b.appendChild(d[1]);var e=i();b.appendChild(e[0]),b.appendChild(e[1]);var f=j();f.forEach(function(a){b.appendChild(a)});var k=document.createElement("div");k.style.clear="both",b.appendChild(k),a.insertBefore(b,a.childNodes[0])}function f(a,b,c){var d=document.createElement("div");d.setAttribute("class","m-"+a+"-selector");var e=document.createElement("ul");e.setAttribute("class","m-"+a+"-list");var f=document.createElement("div");d.appendChild(f);for(var g=[],h=0,i=b;i>h;h++){var j=document.createElement("li"),k=document.createElement("div");k.setAttribute("class","m-"+a),j.appendChild(k),e.appendChild(j),g.push(k)}return d.addEventListener("mouseover",function(){e.setAttribute("style","display:block;")},!1),d.addEventListener("mouseout",function(a){var b=a.toElement||a.relatedTarget;P(e,b)||b===e||e.setAttribute("style","display:none;")},!1),e.addEventListener("mouseout",function(a){var b=a.toElement||a.relatedTarget,c=a.fromElement||a.relatedTarget;(c!==e&&!P(e,c)||b!==e&&!P(e,b))&&e.setAttribute("style","display:none;")}),e.addEventListener("click",function(b){var d;"LI"===b.target.tagName?d=b.target.getElementsByTagName("div")[0]:-1!==b.target.className.indexOf("m-"+a)&&(d=b.target),d&&c(d,f)},!1),[d,e,f,g]}function g(){var a=T.options.WIDGETS.COLOR.HEX.length,b=function(a){var b=a.style["background-color"];T.setColor(b),T.options.WIDGETS.COLOR.ELEMENTS.forEach(function(a){a.style["background-color"]=b})},c=f("color",a,b),d=c[0],e=c[1],g=c[2],h=c[3];return g.style["background-color"]=T.options.WIDGETS.COLOR.HEX[0],T.options.WIDGETS.COLOR.ELEMENTS.push(g),h.forEach(function(a,b){a.style["background-color"]=T.options.WIDGETS.COLOR.HEX[b]}),[d,e]}function h(){var a=T.options.WIDGETS.TOOL.TYPE.length,b=function(a,b){var c=a.getAttribute("data-tool"),d=a.innerText;T.setTool(c),b.innerText=d},c=f("tool",a,b),d=c[0],e=c[1],g=c[2],h=c[3],i=T.options.WIDGETS.TOOL.TYPE[0];return g.innerText=T.options.WIDGETS.TOOL[i].ICON,h.forEach(function(a,b){var c=T.options.WIDGETS.TOOL.TYPE[b],d=T.options.WIDGETS.TOOL[c].ICON;a.setAttribute("data-tool",c),a.innerText=d}),[d,e]}function i(){var a=T.options.WIDGETS.SIZE.length,b=function(a,b){var c=a.style.width,d=c.substring(0,c.length-2)/2;T.setSize(d),b.getElementsByTagName("div")[0].style.width=c,b.getElementsByTagName("div")[0].style.height=c},c=f("size",a,b),d=c[0],e=c[1],g=c[2],h=c[3],i=document.createElement("div");return i.setAttribute("class","m-size"),i.style.width=T.options.WIDGETS.SIZE[0]+"px",i.style.height=T.options.WIDGETS.SIZE[0]+"px",i.style["background-color"]=T.options.WIDGETS.COLOR.HEX[0],g.appendChild(i),T.options.WIDGETS.COLOR.ELEMENTS.push(i),h.forEach(function(a,b){var c=T.options.WIDGETS.SIZE[b];a.style.width=c+"px",a.style.height=c+"px",a.style["background-color"]=T.options.WIDGETS.COLOR.HEX[0],T.options.WIDGETS.COLOR.ELEMENTS.push(a)}),[d,e]}function j(){var a=[],b=function(a){return function(){O(T[a.METHOD])&&T[a.METHOD].call(T)}};for(var c in T.options.WIDGETS.GENERAL)if(T.options.WIDGETS.GENERAL.hasOwnProperty(c)){var d=T.options.WIDGETS.GENERAL[c],e=document.createElement("div"),f=document.createElement("span");f.innerText=d.ICON,f.setAttribute("class","m-"+d.METHOD),e.appendChild(f),e.setAttribute("class","m-button"),e.setAttribute("title",d.METHOD),e.addEventListener("click",b(d),!1),a.push(e)}return a}function k(){T.options.start_trigger.forEach(function(a){V.el.addEventListener(a,l,!1)}),T.options.move_trigger.forEach(function(a){V.el.addEventListener(a,m,!1)}),T.options.stop_trigger.forEach(function(a){V.el.addEventListener(a,n,!1)}),V.el.addEventListener("mouseover",o,!1),V.el.addEventListener("mouseout",p,!1)}function l(a){a.preventDefault(),a.stopPropagation(),V.paint_start===b&&(V.paint_start=L());var c=I(a);M("Start: "+c.x+","+c.y),q(c,V.config),V.is_mousedown=!0}function m(a){if(V.is_mousedown===!0){a.preventDefault(),a.stopPropagation();var b=I(a);M("Move: "+b.x+","+b.y),q(b,V.config)}F(a)}function n(a){a.preventDefault(),a.stopPropagation();var b=I(a);M("Stop: "+b.x+","+b.y),q(b,V.config),s()}function o(a){J(a,V.el)&&(M("Enter",a),C(a))}function p(a){var b=a.toElement?a.toElement:a.relatedTarget;(null===b||"svg"!==b.nodeName&&"svg"!==b.parentNode.nodeName&&b.id!==T.options.cursor_id)&&(V.is_mousedown===!0&&(M("Out",a),s()),G())}function q(a,b){A(b.element_index).push(a),w(b)}function r(a){return V.paint_stack.elements[a]={config:{element_index:a,tool:V.config.tool,painter_radius:V.config.painter_radius,opacity:V.config.opacity,color:V.config.color},points:[],is_deleted:!1},V.paint_stack.elements[a]}function s(){V.is_mousedown=!1,u(V.config);for(var a=V.redo.length-1;a>=0;a--)V.undo.push({id:V.redo[a].id,value:K(V.redo[a].value)});for(var b=0,c=V.redo.length;c>b;b++)V.undo.push({id:V.redo[b].id,value:V.redo[b].value});V.undo.push({id:V.config.element_index,value:"d"}),V.redo=[],V.config.element_index++}function t(a){var b=S(T.options.element_prefix+a);b&&b.parentNode.removeChild(b)}function u(a){var b=S(T.options.element_prefix+a.element_index);b&&b.setAttribute("opacity",a.opacity)}function v(){for(;V.el.lastChild;)V.el.removeChild(V.el.lastChild)}function w(a,b){switch(a.tool){case T.options.WIDGETS.TOOL.PAINT.NAME:x(a,b);break;case T.options.WIDGETS.TOOL.LINE.NAME:z(a,b)}}function x(a,b){var c=T.options.element_prefix+a.element_index,d=S(c);d?d.setAttribute("d",y(a.element_index,b)):(d=H("path",{id:c,d:y(a.element_index,b),fill:"none",stroke:a.color,"stroke-linecap":"round","stroke-width":2*a.painter_radius,opacity:a.opacity/2}),V.el.appendChild(d))}function y(a,b){var c=b||A(a),d=c.length,e=0===d%2?d-1:d-2,f="M"+c[0].x+","+c[0].y;if(1===d)return f;if(2===d||3===d)return f+"T"+c[d-1].x+","+c[d-1].y;f+="Q";for(var g=1;e>g;g++)f+=c[g].x+","+c[g].y+" ";return f+="T"+c[e].x+","+c[e].y}function z(a,b){var c=T.options.element_prefix+a.element_index,d=S(c);if(d){var e=B(b,a.element_index);d.setAttribute("x2",e.x),d.setAttribute("y2",e.y)}else{var f=B(b,a.element_index,0),g=B(b,a.element_index);d=H("line",{id:c,x1:f.x,y1:f.y,x2:g.x,y2:g.y,"stroke-linecap":"round","stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2}),V.el.appendChild(d)}}function A(a){return V.paint_stack.elements[a]===b?r(a).points:V.paint_stack.elements[a].points}function B(a,c,d){var e=a||A(c);return d===b?e[e.length-1]:e[d]}function C(a){switch(V.config.tool){case T.options.WIDGETS.TOOL.PAINT.NAME:D(a);break;case T.options.WIDGETS.TOOL.LINE.NAME:E(a)}}function D(a){var b=H("circle",{id:T.options.cursor_id,cx:a.offsetX,cy:a.offsetY,r:V.config.painter_radius,stroke:V.config.color,fill:V.config.color});V.el.appendChild(b)}function E(){var a="";V.el.getAttribute("style")&&(a=V.el.getAttribute("style")),V.el.setAttribute("style",a+"cursor:crosshair;")}function F(a){var b=S(T.options.cursor_id);b&&(b.setAttribute("cx",a.offsetX),b.setAttribute("cy",a.offsetY))}function G(){var a=S(T.options.cursor_id),b=V.el.getAttribute("style");a&&a.parentNode.removeChild(a),b&&V.el.setAttribute("style",b.replace(/cursor:crosshair;/,""))}function H(a,b){var c=document.createElementNS(W,a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}function I(b){var c,d,e=b||a.event;return N(e)?e.targetTouches.length?(c=e.targetTouches[0].clientX,d=e.targetTouches[0].clientY-V.el.offsetTop+a.scrollY):(c=e.changedTouches[0].clientX,d=e.changedTouches[0].clientY-V.el.offsetTop+a.scrollY):(c=e.offsetX,d=e.offsetY),{x:c,y:d,timestamp:L()}}function J(a,b){for(var c=a.relatedTarget||a.toElement||a.fromElement;c&&c!==b;)c=c.parentNode;return c!==b?!0:!1}function K(a){return"d"===a?"a":"a"===a?"d":"redo"===a?"undo":"undo"===a?"redo":a}function L(){return+new Date}function M(a){T.options.debug===!0&&console.log(a)}function N(){return event.type.search("touch")>-1}function O(a){return"function"==typeof a}function P(a,b){for(var c=b.parentNode;null!==c;){if(c===a)return!0;c=c.parentNode}return!1}function Q(){for(var a={},b=0,c=arguments.length;c>b;b++)for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}function R(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||function(b){a.setTimeout(b,1e3/60)}}function S(a){return document.getElementById(a)}var T,U=a.mPainter||{},V={},W="http://www.w3.org/2000/svg";U=function(a,d){var e={id:"m-board",cursor_id:"m-cursor",element_prefix:"element_",ui:{widget:{enable:!0}},width:600,height:400,hook_id:a,start_trigger:["mousedown","touchstart","MSPointerDown"],move_trigger:["mousemove","touchmove","MSPointerMove"],stop_trigger:["mouseup","touchend","touchcancel","MSPointerUp"],debug:!1},f={UI:{widget_group_classname:"m-button-groups"},WIDGETS:{COLOR:{HEX:["#FF0000","#0063DC","#66CEFF","#73BA37","#FFCC33","#E47911","#FF0084","#6441A5","#C7C5E6","#171515"],ELEMENTS:[]},TOOL:{TYPE:["PAINT","LINE"],PAINT:{NAME:"PAINT",ICON:"✐"},LINE:{NAME:"LINE",ICON:"✑"}},SIZE:[4,8,12],GENERAL:{UNDO:{METHOD:"undo",ICON:"↶"},REDO:{METHOD:"redo",ICON:"↷"},REPLAY:{METHOD:"replay",ICON:"⟳"},RESET:{METHOD:"reset",ICON:"♲"}}}};this.options=Q(e,d,f),T=this,c(this.options.ui),V={el:S(this.options.id),undo:[],redo:[],is_mousedown:!1,paint_start:b,paint_stack:{elements:[]},config:{element_index:0,tool:"PAINT",painter_radius:2,opacity:1,color:"#FF0000"}},k()},U.prototype={setColor:function(a){V.config.color=a},setSize:function(a){V.config.painter_radius=a},setOpacity:function(a){V.config.opacity=a},setTool:function(a){if(!this.options.WIDGETS.TOOL[a])throw"TOOL: "+a+" is not available.";V.config.tool=a},undo:function(){this.exec("undo")},redo:function(){this.exec("redo")},saveImage:function(){var b=S("mycanvas"),c=b.getContext("2d"),d=(new XMLSerializer).serializeToString(V.el),e=a.URL||a.webkitURL||a,f=document.createElement("img"),g=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),h=e.createObjectURL(g);f.onload=function(){c.drawImage(f,0,0,b.width,b.height),b.toDataURL("image/png")},f.src=h},replay:function(a){var c=V.paint_stack.elements,d=c.length,e=R(),f=L(),g=0,h=0,i=0,j=0,k=[];v();var l=function(){var m,n,o,p=V.paint_start+g+(L()-f);for(o=h;d-1>=o;o++){var q=c[o].points,r=q[0].timestamp,s=q[q.length-1].timestamp;if(c[o].is_deleted!==!0){if(s>p)break}else g+=s-r}for(o>d-1&&(o=d-1),m=h;o>=m;m++){var t=c[m],v=t.points.length;if(t.is_deleted!==!0)for(n=i;v>n;n++){var x=t.points[n];if(x.timestamp>p){i=n;break}k.push(x),w(t.config,k),k.length===v&&(i=0,k=[],j++,u(t.config))}}j===d?a!==b&&O(a)&&a():(h=o,e(l))};e(l)},exec:function(a){if(V[a].length){var b=V[a].pop(),c=b.id,d=b.value;switch(V[K(a)].push({id:c,value:K(d)}),d){case"a":V.paint_stack.elements[c].is_deleted=!1;var e=V.paint_stack.elements[c].config;e.opacity*=2,w(e);break;case"d":V.paint_stack.elements[c].is_deleted=!0,t(c)}}},getInternal:function(){return V},reset:function(){V.undo=[],V.redo=[],V.config.element_index=0,V.is_mousedown=!1,V.paint_start=b,V.paint_stack={elements:[]},v()}},a.mPainter=U}(window);