/*!
mPainter v0.1.2 
Author: Mark Zhou 
Date: 2013-09-28 
License: MIT 
*/
!function(a,b){"use strict";function c(){D(G.options.startTrigger,function(a){E(I.el,a,d)}),D(G.options.moveTrigger,function(a){E(I.el,a,e)}),D(G.options.stopTrigger,function(a){E(I.el,a,f)}),E(I.el,"mouseover",g),E(I.el,"mouseout",h)}function d(a){B("Mouse down: "+a.offsetX+","+a.offsetY),a.preventDefault(),i(y(a)),I.is_mousedown=!0}function e(a){I.is_mousedown===!0&&(B("Mouse move to: "+a.offsetX+","+a.offsetY),i(y(a))),w(a)}function f(a){I.is_mousedown===!0&&(B("Mouse up: "+a.offsetX+","+a.offsetY),i(y(a)),l())}function g(a){z(a,I.el)&&(B("Mouse enter",a),t(a))}function h(a){var b=a.toElement?a.toElement:a.relatedTarget;(null===b||"svg"!==b.nodeName&&"svg"!==b.parentNode.nodeName&&b.id!==G.options.cursor_id)&&(I.is_mousedown===!0&&(B("Mouse out: "+a.offsetX+","+a.offsetY),l()),x())}function i(a){r(I.config.element_index).push(a),n(I.config)}function j(a){return I.canvasStack.elements[a]={config:{element_index:a,tool:I.config.tool,painter_radius:I.config.painter_radius,opacity:I.config.opacity,color:I.config.color},points:[],is_delelted:!1},I.canvasStack.elements[a]}function k(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}function l(){I.is_mousedown=!1;var a=I.config.element_index,b=F(G.options.element_prefix+a);b&&b.setAttribute("opacity",I.config.opacity);for(var c=I.redo.length-1;c>=0;c--)I.undo.push({id:I.redo[c].id,value:A(I.redo[c].value)});for(var d=0,e=I.redo.length;e>d;d++)I.undo.push({id:I.redo[d].id,value:I.redo[d].value});I.undo.push({id:a,value:"d"}),I.redo=[],I.canvasStack.head=I.config.element_index++}function m(a){var b=F(G.options.element_prefix+a);b&&b.parentNode.removeChild(b)}function n(a){switch(a.tool){case I.TOOLS.PAINT:o(a);break;case I.TOOLS.LINE:q(a)}}function o(a){var b=G.options.element_prefix+a.element_index,c=F(b);c?c.setAttribute("d",p(a.element_index)):(c=k("path",{id:b,d:p(a.element_index),fill:"none",stroke:a.color,"stroke-linecap":"round","stroke-width":2*a.painter_radius,opacity:a.opacity/2}),I.el.appendChild(c))}function p(a){var b=r(a),c=b.length,d=0===c%2?c-1:c-2,e="M"+b[0].x+","+b[0].y;if(1===c)return e;if(2===c||3===c)return e+"T"+b[c-1].x+","+b[c-1].y;e+="Q";for(var f=1;d>f;f++)e+=b[f].x+","+b[f].y+" ";return e+="T"+b[d].x+","+b[d].y}function q(a){var b=G.options.element_prefix+a.element_index,c=F(b);if(c){var d=s(a.element_index);c.setAttribute("x2",d.x),c.setAttribute("y2",d.y)}else{var e=s(a.element_index,0),f=s(a.element_index);c=k("line",{id:b,x1:e.x,y1:e.y,x2:f.x,y2:f.y,"stroke-linecap":"round","stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2}),I.el.appendChild(c)}}function r(a){return I.canvasStack.elements[a]===b?j(a).points:I.canvasStack.elements[a].points}function s(a,c){var d=r(a);return c===b?d[d.length-1]:d[c]}function t(a){switch(I.config.tool){case I.TOOLS.PAINT:u(a);break;case I.TOOLS.LINE:v(a)}}function u(a){var b=k("circle",{id:G.options.cursor_id,cx:a.offsetX,cy:a.offsetY,r:I.config.painter_radius,stroke:I.config.color,fill:I.config.color});I.el.appendChild(b)}function v(){var a="";I.el.getAttribute("style")&&(a=I.el.getAttribute("style")),I.el.setAttribute("style",a+"cursor:crosshair;")}function w(a){var b=F(G.options.cursor_id);b&&(b.setAttribute("cx",a.offsetX),b.setAttribute("cy",a.offsetY))}function x(){var a=F(G.options.cursor_id),b=I.el.getAttribute("style");a&&a.parentNode.removeChild(a),b&&I.el.setAttribute("style",b.replace(/cursor:crosshair;/,""))}function y(a){return{x:a.offsetX,y:a.offsetY}}function z(a,b){for(var c=a.relatedTarget||a.toElement||a.fromElement;c&&c!==b;)c=c.parentNode;return c!==b?!0:!1}function A(a){return"d"===a?"a":"a"===a?"d":"redo"===a?"undo":"undo"===a?"redo":a}function B(a){G.options.debug===!0&&console.log(a)}function C(){for(var a={},b=0,c=arguments.length;c>b;b++)for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}function D(a,b,c){for(var d=0,e=a.length;e>d;d++)b.call(c||null,a[d],d,a)}function E(b,c,d){if(a.addEventListener)b.addEventListener(c,d,!1);else{if(!a.attachEvent)throw"Event type: "+c+" is not supported";b.attachEvent("on"+c,d)}}function F(a){return document.getElementById(a)}var G,H=a.mPainter||{},I={};H=function(a){var b={debug:!1,id:"mysvg",cursor_id:"cursor",element_prefix:"element_",tool:"PAINT",startTrigger:["mousedown","touchstart","MSPointerDown"],moveTrigger:["mousemove","touchmove","MSPointerMove"],stopTrigger:["mouseup","touchend","touchcancel","MSPointerUp"]};this.options=C(b,a),G=this,I={el:F(this.options.id),undo:[],redo:[],is_mousedown:!1,canvasStack:{head:-1,elements:[]},config:{element_index:0,tool:this.options.tool,painter_radius:3,opacity:1,color:"#FF0000"},TOOLS:{PAINT:"PAINT",LINE:"LINE"}},c()},H.prototype={setColor:function(a){I.config.color=a},setSize:function(a){I.config.painter_radius=a},setOpacity:function(a){I.config.opacity=a},setTool:function(a){if(!I.TOOLS[a])throw"TOOL: "+a+" is not available.";I.config.tool=I.TOOLS[a]},undo:function(){this.exec("undo")},redo:function(){this.exec("redo")},saveImage:function(){var b=F("mycanvas"),c=b.getContext("2d"),d=(new XMLSerializer).serializeToString(I.el),e=a.URL||a.webkitURL||a,f=document.createElement("img"),g=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),h=e.createObjectURL(g);f.onload=function(){c.drawImage(f,0,0,b.width,b.height);var a=b.toDataURL("image/png");console.log(a)},f.crossOrigin="anonymous",f.src=h},exec:function(a){if(I[a].length){var b=I[a].pop(),c=b.id,d=b.value;switch(I[A(a)].push({id:c,value:A(d)}),d){case"a":I.canvasStack.elements[c].is_delelted=!1;var e=I.canvasStack.elements[c].config;e.opacity*=2,n(e);break;case"d":I.canvasStack.elements[c].is_delelted=!0,m(c)}}},getInternal:function(){return I},reset:function(){for(I.undo=[],I.redo=[],I.config.element_index=0,I.canvasStack={head:-1,elements:[]},I.is_mousedown=!1;I.el.lastChild;)I.el.removeChild(I.el.lastChild)}},a.mPainter=H}(window);