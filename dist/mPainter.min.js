/*!
mPainter v0.3.0 
Author: Mark Zhou 
Date: 2013-10-06 
License: MIT 
*/
!function(a,b){"use strict";function c(){K.options.start_trigger.forEach(function(a){M.el.addEventListener(a,d,!1)}),K.options.move_trigger.forEach(function(a){M.el.addEventListener(a,e,!1)}),K.options.stop_trigger.forEach(function(a){M.el.addEventListener(a,f,!1)}),M.el.addEventListener("mouseover",g,!1),M.el.addEventListener("mouseout",h,!1)}function d(a){a.preventDefault(),a.stopPropagation(),M.first_draw===!0&&(M.first_draw=!1,M.paint_start=D());var b=A(a);E("Start: "+b.x+","+b.y),i(b),M.is_mousedown=!0}function e(a){if(M.is_mousedown===!0){a.preventDefault(),a.stopPropagation();var b=A(a);E("Move: "+b.x+","+b.y),i(b)}x(a)}function f(a){a.preventDefault(),a.stopPropagation();var b=A(a);E("Stop: "+b.x+","+b.y),i(b),k()}function g(a){B(a,M.el)&&(E("Enter",a),u(a))}function h(a){var b=a.toElement?a.toElement:a.relatedTarget;(null===b||"svg"!==b.nodeName&&"svg"!==b.parentNode.nodeName&&b.id!==K.options.cursor_id)&&(M.is_mousedown===!0&&(E("Out",a),k()),y())}function i(a){var b=s(M.config.element_index);b.push(a),o(M.config)}function j(a){return M.paint_stack.elements[a]={config:{element_index:a,tool:M.config.tool,painter_radius:M.config.painter_radius,opacity:M.config.opacity,color:M.config.color},points:[],is_deleted:!1},M.paint_stack.elements[a]}function k(){M.is_mousedown=!1,m(M.config);for(var a=M.redo.length-1;a>=0;a--)M.undo.push({id:M.redo[a].id,value:C(M.redo[a].value)});for(var b=0,c=M.redo.length;c>b;b++)M.undo.push({id:M.redo[b].id,value:M.redo[b].value});M.undo.push({id:M.config.element_index,value:"d"}),M.redo=[],M.config.element_index++}function l(a){var b=J(K.options.element_prefix+a);b&&b.parentNode.removeChild(b)}function m(a){var b=J(K.options.element_prefix+a.element_index);b&&b.setAttribute("opacity",a.opacity)}function n(){for(;M.el.lastChild;)M.el.removeChild(M.el.lastChild)}function o(a,b){switch(a.tool){case M.TOOLS.PAINT:p(a,b);break;case M.TOOLS.LINE:r(a,b)}}function p(a,b){var c=K.options.element_prefix+a.element_index,d=J(c);d?d.setAttribute("d",q(a.element_index,b)):(d=z("path",{id:c,d:q(a.element_index,b),fill:"none",stroke:a.color,"stroke-linecap":"round","stroke-width":2*a.painter_radius,opacity:a.opacity/2}),M.el.appendChild(d))}function q(a,b){var c=b||s(a),d=c.length,e=0===d%2?d-1:d-2,f="M"+c[0].x+","+c[0].y;if(1===d)return f;if(2===d||3===d)return f+"T"+c[d-1].x+","+c[d-1].y;f+="Q";for(var g=1;e>g;g++)f+=c[g].x+","+c[g].y+" ";return f+="T"+c[e].x+","+c[e].y}function r(a,b){var c=K.options.element_prefix+a.element_index,d=J(c);if(d){var e=t(b,a.element_index);d.setAttribute("x2",e.x),d.setAttribute("y2",e.y)}else{var f=t(b,a.element_index,0),g=t(b,a.element_index);d=z("line",{id:c,x1:f.x,y1:f.y,x2:g.x,y2:g.y,"stroke-linecap":"round","stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2}),M.el.appendChild(d)}}function s(a){return M.paint_stack.elements[a]===b?j(a).points:M.paint_stack.elements[a].points}function t(a,c,d){var e=a||s(c);return d===b?e[e.length-1]:e[d]}function u(a){switch(M.config.tool){case M.TOOLS.PAINT:v(a);break;case M.TOOLS.LINE:w(a)}}function v(a){var b=z("circle",{id:K.options.cursor_id,cx:a.offsetX,cy:a.offsetY,r:M.config.painter_radius,stroke:M.config.color,fill:M.config.color});M.el.appendChild(b)}function w(){var a="";M.el.getAttribute("style")&&(a=M.el.getAttribute("style")),M.el.setAttribute("style",a+"cursor:crosshair;")}function x(a){var b=J(K.options.cursor_id);b&&(b.setAttribute("cx",a.offsetX),b.setAttribute("cy",a.offsetY))}function y(){var a=J(K.options.cursor_id),b=M.el.getAttribute("style");a&&a.parentNode.removeChild(a),b&&M.el.setAttribute("style",b.replace(/cursor:crosshair;/,""))}function z(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}function A(b){var c,d,e=b||a.event;return F(e)?e.targetTouches.length?(c=e.targetTouches[0].clientX,d=e.targetTouches[0].clientY-M.el.offsetTop+a.scrollY):(c=e.changedTouches[0].clientX,d=e.changedTouches[0].clientY-M.el.offsetTop+a.scrollY):(c=e.offsetX,d=e.offsetY),{x:c,y:d,timestamp:D()}}function B(a,b){for(var c=a.relatedTarget||a.toElement||a.fromElement;c&&c!==b;)c=c.parentNode;return c!==b?!0:!1}function C(a){return"d"===a?"a":"a"===a?"d":"redo"===a?"undo":"undo"===a?"redo":a}function D(){return+new Date}function E(a){K.options.debug===!0&&console.log(a)}function F(){return event.type.search("touch")>-1}function G(a){return"function"==typeof a}function H(){for(var a={},b=0,c=arguments.length;c>b;b++)for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}function I(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||function(b){a.setTimeout(b,1e3/60)}}function J(a){return document.getElementById(a)}var K,L=a.mPainter||{},M={};L=function(a){var d={debug:!1,id:"mysvg",cursor_id:"cursor",element_prefix:"element_",tool:"PAINT",start_trigger:["mousedown","touchstart","MSPointerDown"],move_trigger:["mousemove","touchmove","MSPointerMove"],stop_trigger:["mouseup","touchend","touchcancel","MSPointerUp"]};this.options=H(d,a),K=this,M={el:J(this.options.id),undo:[],redo:[],is_mousedown:!1,first_draw:!0,paint_start:b,paint_stack:{head:0,elements:[]},config:{element_index:0,tool:this.options.tool,painter_radius:3,opacity:1,color:"#FF0000"},TOOLS:{PAINT:"PAINT",LINE:"LINE"}},c()},L.prototype={setColor:function(a){M.config.color=a},setSize:function(a){M.config.painter_radius=a},setOpacity:function(a){M.config.opacity=a},setTool:function(a){if(!M.TOOLS[a])throw"TOOL: "+a+" is not available.";M.config.tool=M.TOOLS[a]},undo:function(){this.exec("undo")},redo:function(){this.exec("redo")},saveImage:function(){var b=J("mycanvas"),c=b.getContext("2d"),d=(new XMLSerializer).serializeToString(M.el),e=a.URL||a.webkitURL||a,f=document.createElement("img"),g=new Blob([d],{type:"image/svg+xml;charset=utf-8"}),h=e.createObjectURL(g);f.onload=function(){c.drawImage(f,0,0,b.width,b.height),b.toDataURL("image/png")},f.src=h},replay:function(a){var c=M.paint_stack.elements,d=c.length,e=I(),f=D(),g=0,h=0,i=0,j=[];n();var k=function(){var l,n,p,q=M.paint_start+(D()-f);for(p=g;d-1>=p;p++){var r=c[p].points;if(r[r.length-1].timestamp>q)break}for(p>d-1&&(p=d-1),l=g;p>=l;l++){var s=c[l],t=s.points.length;for(n=h;t>n;n++){var u=s.points[n];if(u.timestamp>q){h=n;break}j.push(u),o(s.config,j),j.length===t&&(h=0,j=[],i++,m(s.config))}}i===d?a!==b&&G(a)&&a():(g=p,e(k))};e(k)},exec:function(a){if(M[a].length){var b=M[a].pop(),c=b.id,d=b.value;switch(M[C(a)].push({id:c,value:C(d)}),d){case"a":M.paint_stack.elements[c].is_deleted=!1;var e=M.paint_stack.elements[c].config;e.opacity*=2,o(e);break;case"d":M.paint_stack.elements[c].is_deleted=!0,l(c)}}},getInternal:function(){return M},reset:function(){M.undo=[],M.redo=[],M.config.element_index=0,M.is_mousedown=!1,M.first_draw=!0,M.paint_start=b,M.paint_stack={head:0,elements:[]},n()}},a.mPainter=L}(window);