/*!
mPainter v0.1.0 
Author: Mark Zhou 
Date: 2013-08-16 
License: MIT 
*/
!function(a,b){"use strict";function c(a){var b=l().push(a);b>2&&0===b%2&&h(z.config)}function d(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}function e(a){return z.canvasStack.elements[a]={config:{element_index:a,tool:z.config.tool,painter_radius:z.config.painter_radius,opacity:z.config.opacity,color:z.config.color},points:[],is_delelted:!1},z.canvasStack.elements[a]}function f(){z.is_mousedown=!1;var a=z.config.element_index,b=t(x.options.element_prefix+a);b&&b.setAttribute("opacity",z.config.opacity);for(var c in z.redo)if(z.redo.hasOwnProperty(c)){var d=(z.redo[c],"d"===z.redo[c].value?"a":"d");z.undo.push({id:z.redo[c].id,value:d}),z.undo.push({id:z.redo[c].id,value:z.redo[c].value})}z.undo.push({id:a,value:"d"}),z.redo=[],z.canvasStack.head=z.config.element_index++}function g(a){z.EVENTS[a.type]&&"function"==typeof z.EVENTS[a.type]&&z.EVENTS[a.type].call(x,a)}function h(a){switch(a.tool){case z.TOOLS.PAINT:i(a);break;case z.TOOLS.LINE:k(a)}}function i(a){var b=x.options.element_prefix+a.element_index,c=t(b);c?c.setAttribute("d",j(a.element_index)):(c=d("path",{id:b,d:j(a.element_index),fill:"none",stroke:a.color,"stroke-linecap":"round","stroke-width":2*a.painter_radius,opacity:a.opacity/2}),z.el.appendChild(c))}function j(a){var b=l(a),c=b.length,d=0===c%2?c-1:c-2,e="M"+b[0].x+","+b[0].y+" Q";b.length;for(var f=1;d>f;f++)e+=b[f].x+","+b[f].y+" ";return e+="T"+b[d].x+","+b[d].y}function k(a){var b=x.options.element_prefix+a.element_index,c=t(b);if(c){var e=m(a.element_index);c.setAttribute("x2",e.x),c.setAttribute("y2",e.y)}else{var f=m(a.element_index,0),g=m(a.element_index);c=d("line",{id:b,x1:f.x,y1:f.y,x2:g.x,y2:g.y,"stroke-linecap":"round","stroke-width":2*a.painter_radius,stroke:a.color,opacity:a.opacity/2}),z.el.appendChild(c)}}function l(a){var c=a===b?z.config.element_index:a;return z.canvasStack.elements[c]===b?c===z.config.element_index?e(c).points:b:z.canvasStack.elements[c].points}function m(a,c){var d=l(a);return c===b?d[d.length-1]:d[c]}function n(a){switch(z.config.tool){case z.TOOLS.PAINT:o(a);break;case z.TOOLS.LINE:p(a)}}function o(a){var b=d("circle",{id:x.options.cursor_id,cx:a.offsetX,cy:a.offsetY,r:z.config.painter_radius,stroke:z.config.color,fill:z.config.color});z.el.appendChild(b)}function p(){var a="";z.el.getAttribute("style")&&(a=z.el.getAttribute("class")),z.el.setAttribute("style",a+"cursor:crosshair;")}function q(a){var b=t(x.options.cursor_id);b&&(b.setAttribute("cx",a.offsetX),b.setAttribute("cy",a.offsetY))}function r(){var a=t(x.options.cursor_id),b=z.el.getAttribute("style");a&&a.parentNode.removeChild(a),b&&z.el.setAttribute("style",b.replace(/cursor:crosshair;/,""))}function s(a){return{x:a.offsetX,y:a.offsetY}}function t(a){return document.getElementById(a)}function u(){for(var a={},b=0,c=arguments.length;c>b;b++)for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}function v(a,b){for(var c=a.relatedTarget||a.toElement||a.fromElement;c&&c!==b;)c=c.parentNode;return c!==b?!0:!1}function w(a){x.options.debug===!0&&console.log(a)}var x,y=a.mPainter||{},z={};y=function(a){x=this,this._init(a)},y.prototype={_init:function(a){var b={debug:!1,id:"mysvg",cursor_id:"cursor",element_prefix:"element_",tool:"PAINT"};this.options=u({},b,a),z={el:t(this.options.id),undo:[],redo:[],is_mousedown:!1,canvasStack:{head:-1,elements:[]},config:{element_index:0,tool:this.options.tool,painter_radius:3,opacity:1,color:"#FF0000"},EVENTS:{mousedown:this._mouseDown,mousemove:this._mouseMove,mouseup:this._mouseUp,mouseover:this._mouseOver,mouseout:this._mouseOut},TOOLS:{PAINT:"PAINT",LINE:"LINE"}},this._initEvents()},_initEvents:function(){z.el.addEventListener("mousedown",g,!1),z.el.addEventListener("mousemove",g,!1),z.el.addEventListener("mouseup",g,!1),z.el.addEventListener("mouseover",g,!1),z.el.addEventListener("mouseout",g,!1)},_mouseDown:function(a){w("Mouse down: "+a.offsetX+","+a.offsetY),a.preventDefault(),c(s(a)),z.is_mousedown=!0},_mouseMove:function(a){z.is_mousedown===!0&&(w("Mouse move to: "+a.offsetX+","+a.offsetY),c(s(a))),q(a)},_mouseUp:function(a){z.is_mousedown===!0&&(w("Mouse up: "+a.offsetX+","+a.offsetY),c(s(a)),f())},_mouseOver:function(a){v(a,z.el)&&(w("Mouse enter",a),n(a))},_mouseOut:function(a){var b=a.toElement?a.toElement:a.relatedTarget;(null===b||"svg"!==b.nodeName&&"svg"!==b.parentNode.nodeName&&b.id!==this.options.cursor_id)&&(z.is_mousedown===!0&&(w("Mouse out: "+a.offsetX+","+a.offsetY),f()),r())},setColor:function(a){z.config.color=a},setPainterSize:function(a){z.config.painter_radius=a},setOpacity:function(a){z.config.opacity=a},setTool:function(a){if(!z.TOOLS[a])throw"TOOL: "+a+" is not available.";z.config.tool=z.TOOLS[a]},undo:function(){if(z.undo.length){var a=z.undo.pop(),b=a.id,c=a.value,d="d"===c?"a":"d";if(z.redo.push({id:b,value:d}),"d"===c){var e=t(this.options.element_prefix+b);z.canvasStack.elements[b].is_delelted=!0,e&&e.parentNode.removeChild(e)}else{var f=z.canvasStack.elements[b].config;f.opacity=2*f.opacity,h(f)}}},redo:function(){if(z.redo.length){var a=z.redo.pop(),b=a.id,c=a.value,d="d"===c?"a":"d";if(z.undo.push({id:b,value:d}),"d"===c){var e=t(this.options.element_prefix+b);z.canvasStack.elements[b].is_delelted=!0,e&&e.parentNode.removeChild(e)}else{var f=z.canvasStack.elements[b].config;f.opacity=2*f.opacity,h(f)}}},getInternal:function(){return z},reset:function(){for(z.config.element_index=0,z.canvasStack={head:-1,elements:[]},z.is_mousedown=!1;z.el.lastChild;)z.el.removeChild(z.el.lastChild)}},a.mPainter=y}(window);